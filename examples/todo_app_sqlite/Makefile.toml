extend = [
  { path = "../cargo-make/main.toml" },
  { path = "../cargo-make/webdriver.toml" },
  { path = "../cargo-make/cargo-leptos.toml" },
]

[tasks.check]
clear = true
dependencies = ["check-debug", "check-release"]

[tasks.check-debug]
toolchain = "nightly"
command = "cargo"
args = ["check-all-features"]
install_crate = "cargo-all-features"

[tasks.check-release]
toolchain = "nightly"
command = "cargo"
args = ["check-all-features", "--release"]
install_crate = "cargo-all-features"

[tasks.integration-test]
dependencies = [
  "install-cargo-leptos",
  "start-webdriver",
  "test-e2e-with-auto-start",
]

[tasks.test-e2e-with-auto-start]
script = '''
  if [ -z $(pidof todo_app_sqlite) ]; then
    cargo leptos watch &
  fi

  cargo make test-ui
'''

[tasks.test-ui]
cwd = "./e2e"
command = "cargo"
args = ["make", "test-ui"]

# Support

[tasks.start]
command = "cargo"
args = ["leptos", "watch"]

[tasks.stop]
script = '''
  if [ ! -z $(pidof todo_app_sqlite) ]; then
    pkill -f todo_app_sqlite
  fi

  if [ ! -z $(pidof cargo-leptos) ]; then
    pkill -f cargo-leptos
  fi
'''

[tasks.status]
script = '''
  if [ -z $(pidof todo_app_sqlite) ]; then
    echo "  todo_app_sqlite is not running"
  else
    echo "  todo_app_sqlite is up"
  fi

  if [ -z $(pidof cargo-leptos) ]; then
    echo "  cargo-leptos is not running"
  else
    echo "  cargo-leptos is up"
  fi
'''
